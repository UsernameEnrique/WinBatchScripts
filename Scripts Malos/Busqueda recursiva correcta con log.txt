@echo off
:: Definir la ruta de la carpeta raíz
set "carpetaRaiz=C:\Ruta\A\Carpeta raíz"

:: Definir el nombre y dirección del archivo de registro
set "archivoLog=%carpetaRaiz%\registro_de_ejecucion.log"

:: Verificar si la carpeta raíz existe
if not exist "%carpetaRaiz%" (
    echo Error: La carpeta raíz no existe.
    echo Ruta especificada: "%carpetaRaiz%"
    echo Por favor, verifica la ruta y asegúrate de que exista.
    pause
    exit /b
)

:: Redirigir toda la salida de los siguientes comandos al archivo de registro
(
    echo Inicia el proceso de mover y limpiar carpetas...
    echo.

    :: Buscar todos los archivos en las subcarpetas y moverlos a la carpeta raíz
    for /r "%carpetaRaiz%" %%f in (*) do (
        if not "%%~dpf"=="%carpetaRaiz%\" (
            call :MoverArchivoSeguro "%%f" "%carpetaRaiz%"
        )
    )

    echo.
    echo Proceso de mover archivos finalizado.
    echo Iniciando la eliminación de subcarpetas vacías...
    echo.

    :: Eliminar las subcarpetas vacías
    for /d /r "%carpetaRaiz%" %%d in (*) do (
        rd "%%d" 2>nul
    )

    echo.
    echo Tarea completada con éxito.

) > "%archivoLog%" 2>&1

echo Proceso finalizado. Se ha generado un registro en: "%archivoLog%"
pause
exit /b

:MoverArchivoSeguro
setlocal enabledelayedexpansion
set "archivo=%~1"
set "destino=%~2"
set "nombreArchivo=%~n1"
set "extension=%~x1"
set "archivoDestino=%destino%\%~nx1"
set "contador=1"

:: Verificar si el archivo ya existe en el destino
if exist "!archivoDestino!" (
    :: Buscar un nombre disponible agregando un número
    :BuscarNombre
    set "nuevoNombre=%nombreArchivo%_!contador!%extension%"
    set "archivoDestino=%destino%\!nuevoNombre!"
    if exist "!archivoDestino!" (
        set /a contador+=1
        goto :BuscarNombre
    )
    echo Archivo renombrado: !nuevoNombre!
)

:: Mover el archivo con el nombre disponible
move "!archivo!" "!archivoDestino!" >nul
if !errorlevel! equ 0 (
    echo Movido: %~nx1 ^> !nuevoNombre!
) else (
    echo Error moviendo: %~nx1
)
endlocal
exit /b